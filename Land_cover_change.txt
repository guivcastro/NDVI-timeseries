// Google Earth Engine script


// Land cover change analysis from two Land Cover Maps with 25m of resolution

// Load land cover maps
var img90_native = ee.Image('PATH/TO/FILE');
var img23_native = ee.Image('PATH/TO/FILE');

// Resample land cover maps to 30m
var lc90 = img90_native.select('b1').toInt().reproject({
  crs: img90_native.projection(),
  scale: 30
});

var lc23 = img23_native.select('b1').toInt().reproject({
  crs: img90_native.projection(),
  scale: 30
});

// Align rasters
var aoi = lc90.geometry().intersection(lc23.geometry(), ee.ErrorMargin(1));
lc90 = lc90.clip(aoi);
lc23 = lc23.clip(aoi);

// Mask non-target land cover categories
var maskNoData = lc90.neq(0);
lc90 = lc90.updateMask(maskNoData);
lc23 = lc23.updateMask(maskNoData);

// Define built-up land cover codes
var mask = ee.List([0, 8, 11, 12, 13, 14, 15, 16, 17, 18, 20, 21]);

// Detect change
var change = lc23.neq(lc90).rename('change');

// Exclude non-target land cover categories from change analysis
var built = ee.Image.constant(mask).eq(lc23).reduce('max');
var changeNoBuilt = change.updateMask(built.not());

// Load boundaries
var boundaries = ee.FeatureCollection('PATH/TO/FILE');

// Clip change mask to boundaries
var changeClipped = changeNoBuilt.clip(boundaries);

// Mask NDVI asset
var new_asset_layer = ee.Image('PATH/TO/FILE');
var noChangeMask = new_asset_layer.updateMask(changeClipped.eq(0));
var changeMask = new_asset_layer.updateMask(changeClipped.eq(1));

// Export rasters

Export.image.toAsset({
  image: changeClipped,
  description: 'Land_cover_change_1990_2023_30m',
  assetId: 'path/',
  region: boundaries,
  scale: 30,
  maxPixels: 1e13,
  crs: 'EPSG:32631'
});

Export.image.toAsset({
  image: noChangeMask,
  description: 'LC_no_change_30m',
  region: boundaries,
  scale: 30,
  maxPixels: 1e13,
  crs: 'EPSG:32631'
});

Export.image.toAsset({
  image: changeMask,
  description: 'LC_change_30m',
  region: boundaries,
  scale: 30,
  maxPixels: 1e13,
  crs: 'EPSG:32631'
});

// Calculate change per land cover class and export csv

var classes = ee.List.sequence(1, 21);
var changePerClass = classes.map(function(c) {
  c = ee.Number(c);
  var classMask = lc90.eq(c).and(changeClipped.eq(1));
  var count = classMask.reduceRegion({
    reducer: ee.Reducer.sum(),
    geometry: boundaries,
    scale: 30,
    maxPixels: 1e13
  }).get('b1');
  
  return ee.Feature(null, {
    'class_1990': c,
    'changed_pixels': ee.Number(count)
  });
});

var changeFC = ee.FeatureCollection(changePerClass);

Export.table.toDrive({
  collection: changeFC,
  description: 'LC_change_1990_class',
  fileFormat: 'CSV'
});

